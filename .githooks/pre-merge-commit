#!/bin/sh
# Pre-merge-commit hook - Ensure release-manifest.json is committed on release/hotfix branches

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Only run on release or hotfix branches
if ! echo "$current_branch" | grep -qE "^(release|hotfix)/"; then
    exit 0
fi

# Check if release-manifest.json exists in HEAD
if git ls-tree HEAD release-manifest.json | grep -q .; then
    # File exists in HEAD
    if ! git ls-files --stage release-manifest.json | grep -q .; then
        # File is not in the index (was deleted in merge)
        echo "üîí Restoring release-manifest.json on $current_branch branch..."

        # Restore the file from HEAD and add it to the merge commit
        git checkout HEAD -- release-manifest.json
        git add release-manifest.json

        if [ $? -eq 0 ]; then
            echo "‚úì release-manifest.json restored and staged for merge commit"
        else
            echo "‚ö†Ô∏è  Failed to restore release-manifest.json"
            exit 1
        fi
    else
        # File is staged - ensure it stays staged for the merge commit
        # This handles the case where the merge driver preserved the file
        # Check if the staged version matches HEAD (no actual changes)
        staged_hash=$(git ls-files --stage release-manifest.json | awk '{print $2}')
        head_hash=$(git ls-tree HEAD release-manifest.json | awk '{print $3}')

        if [ "$staged_hash" = "$head_hash" ]; then
            # File is staged but unchanged from HEAD - ensure it's included in merge commit
            # by explicitly staging it again (no-op but ensures it's in the commit)
            git add release-manifest.json
        fi
    fi
fi

exit 0
