name: üß™ Run Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  discover-projects:
    runs-on: ubuntu-latest
    name: Discover Projects
    outputs:
      projects: ${{ steps.discover.outputs.projects }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for Nerdbank.GitVersioning
          sparse-checkout: |
            Umbraco.Ai
            Umbraco.Ai.*
          sparse-checkout-cone-mode: false

      - name: Discover projects
        id: discover
        run: |
          # Dynamically discover all Umbraco.Ai* projects
          # Umbraco.Ai/ -> "Core" (Umbraco.Ai)
          # Umbraco.Ai.<name>/ -> "<Name>" (Umbraco.Ai.<Name>)

          PROJECTS="[]"

          for dir in Umbraco.Ai*/; do
            if [ -d "$dir" ]; then
              dir_name=$(basename "$dir")

              # Find solution file in the directory
              solution_file=$(find "$dir" -maxdepth 1 -name "*.sln" | head -n 1)

              if [ -n "$solution_file" ]; then
                solution_name=$(basename "$solution_file")

                if [ "$dir_name" = "Umbraco.Ai" ]; then
                  # Core project
                  project_json=$(jq -n \
                    --arg name "Core" \
                    --arg path "$dir_name" \
                    --arg solution "$solution_name" \
                    '{name: $name, path: $path, solution: $solution}')
                elif [[ "$dir_name" =~ ^Umbraco\.Ai\.(.+)$ ]]; then
                  # Add-on or provider project
                  project_name="${BASH_REMATCH[1]}"
                  project_json=$(jq -n \
                    --arg name "$project_name" \
                    --arg path "$dir_name" \
                    --arg solution "$solution_name" \
                    '{name: $name, path: $path, solution: $solution}')
                fi

                PROJECTS=$(echo "$PROJECTS" | jq --argjson project "$project_json" '. + [$project]')
              else
                echo "Warning: No solution file found in $dir_name"
              fi
            fi
          done

          echo "Discovered projects:"
          echo "$PROJECTS" | jq .

          # Output as JSON for matrix
          echo "projects=$(echo "$PROJECTS" | jq -c .)" >> $GITHUB_OUTPUT

  test:
    runs-on: ubuntu-latest
    name: Test ${{ matrix.project.name }}
    needs: discover-projects
    if: needs.discover-projects.outputs.projects != '[]'

    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.projects) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for Nerdbank.GitVersioning

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore ${{ matrix.project.path }}/${{ matrix.project.solution }}

      - name: Build
        run: dotnet build ${{ matrix.project.path }}/${{ matrix.project.solution }} --configuration Release --no-restore

      - name: Check for test projects
        id: check-tests
        run: |
          # Check if solution contains any test projects
          test_projects=$(dotnet sln ${{ matrix.project.path }}/${{ matrix.project.solution }} list | grep -i "test" || true)
          if [ -z "$test_projects" ]; then
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No test projects found in ${{ matrix.project.name }}"
          else
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "‚úì Found test projects:"
            echo "$test_projects"
          fi

      - name: Run tests
        if: steps.check-tests.outputs.has_tests == 'true'
        run: dotnet test ${{ matrix.project.path }}/${{ matrix.project.solution }} --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Skip tests (none found)
        if: steps.check-tests.outputs.has_tests == 'false'
        run: echo "‚ö†Ô∏è Skipping tests - no test projects found in this solution"

      - name: Upload test results
        if: always() && steps.check-tests.outputs.has_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.project.name }}
          path: '**/TestResults/*.trx'
