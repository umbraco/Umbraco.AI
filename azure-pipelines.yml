# Azure DevOps CI Pipeline for Umbraco.Ai
# Converted from GitHub Actions (.github/workflows/ci.yml)

trigger:
  branches:
    include:
      - main
      - dev
      - release/*
      - hotfix/*
  tags:
    include:
      - release-*

pr:
  branches:
    include:
      - main
      - dev

variables:
  NODE_VERSION: '20.x'
  DOTNET_NOLOGO: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

stages:
  # ============================================================
  # Build & Test everything
  # ============================================================
  - stage: Build
    displayName: Build & Test
    jobs:
      - job: BuildAndTest
        displayName: Build & Test
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: UseDotNet@2
            displayName: Setup .NET
            inputs:
              useGlobalJson: true

          - task: NodeTool@0
            displayName: Setup Node.js
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              npm ci
              npm run build
            displayName: Build frontend

          - script: dotnet restore Umbraco.Ai.sln
            displayName: Restore

          - script: dotnet build Umbraco.Ai.sln --configuration Release --no-restore
            displayName: Build

          - script: dotnet test Umbraco.Ai.sln --configuration Release --no-build --verbosity normal --logger trx --results-directory $(Agent.TempDirectory)/TestResults
            displayName: Test

          - task: PublishTestResults@2
            displayName: Publish test results
            condition: always()
            inputs:
              testResultsFormat: VSTest
              testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
              mergeTestResults: true

          - task: PublishPipelineArtifact@1
            displayName: Upload build outputs
            inputs:
              targetPath: $(Build.SourcesDirectory)
              artifact: build-outputs
              publishLocation: pipeline

  # ============================================================
  # Pack Stage - Only runs on push to main/dev or release tags
  # ============================================================
  - stage: Pack
    displayName: Pack NuGet Packages
    dependsOn: Build
    # Only pack on push (not PR) to main/dev branches or release tags
    condition: |
      and(
        succeeded(),
        ne(variables['Build.Reason'], 'PullRequest'),
        or(
          startsWith(variables['Build.SourceBranch'], 'refs/tags/release-'),
          eq(variables['Build.SourceBranch'], 'refs/heads/main'),
          eq(variables['Build.SourceBranch'], 'refs/heads/dev')
        )
      )
    jobs:
      # ============================================================
      # Pack Tier 1 (Core - no internal dependencies)
      # ============================================================
      - job: PackTier1
        displayName: Pack Tier 1 (Core)
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: UseDotNet@2
            displayName: Setup .NET
            inputs:
              useGlobalJson: true

          - task: DownloadPipelineArtifact@2
            displayName: Download build outputs
            inputs:
              artifact: build-outputs
              path: $(Build.SourcesDirectory)

          - template: build/templates/pack-product.yml
            parameters:
              product: Umbraco.Ai

          - task: PublishPipelineArtifact@1
            displayName: Upload Umbraco.Ai packages
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/nupkg
              artifact: Umbraco.Ai-packages
              publishLocation: pipeline

      # ============================================================
      # Pack Tier 2 (Providers - depend on Core)
      # ============================================================
      - job: PackTier2
        displayName: Pack Tier 2
        dependsOn: PackTier1
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            OpenAi:
              product: Umbraco.Ai.OpenAi
            Anthropic:
              product: Umbraco.Ai.Anthropic
            Amazon:
              product: Umbraco.Ai.Amazon
            Google:
              product: Umbraco.Ai.Google
            MicrosoftFoundry:
              product: Umbraco.Ai.MicrosoftFoundry
          maxParallel: 5
        steps:
          - checkout: self
            fetchDepth: 0

          - task: UseDotNet@2
            displayName: Setup .NET
            inputs:
              useGlobalJson: true

          - task: DownloadPipelineArtifact@2
            displayName: Download build outputs
            inputs:
              artifact: build-outputs
              path: $(Build.SourcesDirectory)

          - task: DownloadPipelineArtifact@2
            displayName: Download Tier 1 packages (local feed)
            inputs:
              artifact: Umbraco.Ai-packages
              path: $(Build.SourcesDirectory)/artifacts/nupkg

          - template: build/templates/pack-product.yml
            parameters:
              product: $(product)

          - task: PublishPipelineArtifact@1
            displayName: Upload $(product) packages
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/nupkg
              artifact: $(product)-packages
              publishLocation: pipeline

      # ============================================================
      # Pack Tier 3 (Add-ons - depend on Core + Startup)
      # ============================================================
      - job: PackTier3
        displayName: Pack Tier 3
        dependsOn: PackTier1
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            Prompt:
              product: Umbraco.Ai.Prompt
            Agent:
              product: Umbraco.Ai.Agent
          maxParallel: 2
        steps:
          - checkout: self
            fetchDepth: 0

          - task: UseDotNet@2
            displayName: Setup .NET
            inputs:
              useGlobalJson: true

          - task: DownloadPipelineArtifact@2
            displayName: Download build outputs
            inputs:
              artifact: build-outputs
              path: $(Build.SourcesDirectory)

          - task: DownloadPipelineArtifact@2
            displayName: Download Tier 1 packages (local feed)
            inputs:
              artifact: Umbraco.Ai-packages
              path: $(Build.SourcesDirectory)/artifacts/nupkg

          - template: build/templates/pack-product.yml
            parameters:
              product: $(product)

          - task: PublishPipelineArtifact@1
            displayName: Upload $(product) packages
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/nupkg
              artifact: $(product)-packages
              publishLocation: pipeline

      # ============================================================
      # Collect all packages into single artifact
      # ============================================================
      - job: CollectPackages
        displayName: Collect All Packages
        dependsOn:
          - PackTier1
          - PackTier2
          - PackTier3
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai packages
            inputs:
              artifact: Umbraco.Ai-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.OpenAi packages
            inputs:
              artifact: Umbraco.Ai.OpenAi-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.Anthropic packages
            inputs:
              artifact: Umbraco.Ai.Anthropic-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.Amazon packages
            inputs:
              artifact: Umbraco.Ai.Amazon-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.Google packages
            inputs:
              artifact: Umbraco.Ai.Google-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.MicrosoftFoundry packages
            inputs:
              artifact: Umbraco.Ai.MicrosoftFoundry-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.Prompt packages
            inputs:
              artifact: Umbraco.Ai.Prompt-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: DownloadPipelineArtifact@2
            displayName: Download Umbraco.Ai.Agent packages
            inputs:
              artifact: Umbraco.Ai.Agent-packages
              path: $(Build.SourcesDirectory)/all-packages

          - task: PublishPipelineArtifact@1
            displayName: Upload combined artifact
            inputs:
              targetPath: $(Build.SourcesDirectory)/all-packages
              artifact: all-nuget-packages
              publishLocation: pipeline
