# Umbraco.Ai Monorepo CI/CD Pipeline
# Supports independent versioning and building per product

trigger:
  branches:
    include:
      - main
      - dev
      - release/*
      - hotfix/*
  tags:
    include:
      - release-*

pr:
  branches:
    include:
      - main
      - dev

# Pipeline variables
variables:
  - name: configuration
    value: 'Release'
  - name: vmImage
    value: 'ubuntu-latest'

stages:
  # Stage 1: Detect Changes
  - stage: DetectChanges
    displayName: 'Detect Changed Products'
    jobs:
      - job: DetectChanges
        displayName: 'Analyze changes and set variables'
        pool:
          vmImage: $(vmImage)

        steps:
          - checkout: self
            fetchDepth: 2  # Need last 2 commits for diff

          - task: PowerShell@2
            name: detectChanges
            displayName: 'Run change detection'
            inputs:
              filePath: '$(Build.SourcesDirectory)/build/scripts/detect-changes.ps1'
              arguments: '-SourceBranch "$(Build.SourceBranch)" -SourceVersion "$(Build.SourceVersion)"'

  # Stage 2-6: Build Products by Dependency Level
  # Products at each level are built in parallel, but levels are sequential
  # Level 0 = no dependencies, Level 1 = depends on Level 0, etc.

  - stage: BuildLevel0
    displayName: 'Build Level 0 (No Dependencies)'
    dependsOn: DetectChanges
    condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.Level0Changed'], 'true')
    jobs:
      - template: build/templates/build-product.yml
        parameters:
          productName: 'Umbraco.Ai'
          productPath: 'Umbraco.Ai'
          hasFrontend: true
          configuration: $(configuration)
          condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.CoreChanged'], 'true')

  - stage: BuildLevel1
    displayName: 'Build Level 1'
    dependsOn:
      - DetectChanges
      - BuildLevel0
    condition: and(or(succeeded(), eq(dependencies.BuildLevel0.result, 'Skipped')), eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.Level1Changed'], 'true'))
    jobs:
      - template: build/templates/build-product.yml
        parameters:
          productName: 'Umbraco.Ai.Agent'
          productPath: 'Umbraco.Ai.Agent'
          hasFrontend: true
          configuration: $(configuration)
          condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.AgentChanged'], 'true')

      - template: build/templates/build-product.yml
        parameters:
          productName: 'Umbraco.Ai.Prompt'
          productPath: 'Umbraco.Ai.Prompt'
          hasFrontend: true
          configuration: $(configuration)
          condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.PromptChanged'], 'true')

      - template: build/templates/build-product.yml
        parameters:
          productName: 'Umbraco.Ai.OpenAi'
          productPath: 'Umbraco.Ai.OpenAi'
          hasFrontend: false
          configuration: $(configuration)
          condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.OpenAiChanged'], 'true')

      - template: build/templates/build-product.yml
        parameters:
          productName: 'Umbraco.Ai.Anthropic'
          productPath: 'Umbraco.Ai.Anthropic'
          hasFrontend: false
          configuration: $(configuration)
          condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.AnthropicChanged'], 'true')

  # Level 2-4 stages are available for future products with deeper dependency chains
  - stage: BuildLevel2
    displayName: 'Build Level 2'
    dependsOn:
      - DetectChanges
      - BuildLevel1
    condition: and(or(succeeded(), eq(dependencies.BuildLevel1.result, 'Skipped')), eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.Level2Changed'], 'true'))
    jobs:
      # Add future products that depend on Level 1 products here
      - job: Placeholder
        displayName: 'No Level 2 products yet'
        steps:
          - script: echo "No Level 2 products configured"

  - stage: BuildLevel3
    displayName: 'Build Level 3'
    dependsOn:
      - DetectChanges
      - BuildLevel2
    condition: and(or(succeeded(), eq(dependencies.BuildLevel2.result, 'Skipped')), eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.Level3Changed'], 'true'))
    jobs:
      - job: Placeholder
        displayName: 'No Level 3 products yet'
        steps:
          - script: echo "No Level 3 products configured"

  - stage: BuildLevel4
    displayName: 'Build Level 4'
    dependsOn:
      - DetectChanges
      - BuildLevel3
    condition: and(or(succeeded(), eq(dependencies.BuildLevel3.result, 'Skipped')), eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.Level4Changed'], 'true'))
    jobs:
      - job: Placeholder
        displayName: 'No Level 4 products yet'
        steps:
          - script: echo "No Level 4 products configured"

  # Stage 7: Run Tests (Parallel)
  - stage: Test
    displayName: 'Run Tests'
    dependsOn:
      - BuildLevel0
      - BuildLevel1
      - BuildLevel2
      - BuildLevel3
      - BuildLevel4
    jobs:
      - job: TestCore
        displayName: 'Test Umbraco.Ai (Core)'
        pool:
          vmImage: $(vmImage)
        condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.CoreChanged'], 'true')
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Run Core tests'
            inputs:
              command: 'test'
              projects: 'Umbraco.Ai/Umbraco.Ai.sln'
              arguments: '--configuration $(configuration) --collect:"XPlat Code Coverage"'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'

      - job: TestAgent
        displayName: 'Test Umbraco.Ai.Agent'
        pool:
          vmImage: $(vmImage)
        condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.AgentChanged'], 'true')
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Run Agent tests'
            inputs:
              command: 'test'
              projects: 'Umbraco.Ai.Agent/Umbraco.Ai.Agent.sln'
              arguments: '--configuration $(configuration)'

      - job: TestPrompt
        displayName: 'Test Umbraco.Ai.Prompt'
        pool:
          vmImage: $(vmImage)
        condition: eq(stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.PromptChanged'], 'true')
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Run Prompt tests'
            inputs:
              command: 'test'
              projects: 'Umbraco.Ai.Prompt/Umbraco.Ai.Prompt.sln'
              arguments: '--configuration $(configuration)'

  # Stage 4: Deploy to MyGet (optional, requires variable group)
  # - stage: DeployMyGet
  #   displayName: 'Deploy to MyGet'
  #   dependsOn: Test
  #   condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  #   jobs:
  #     - job: Deploy
  #       displayName: 'Push packages to MyGet'
  #       pool:
  #         vmImage: $(vmImage)
  #       steps:
  #         - task: DownloadPipelineArtifact@2
  #           displayName: 'Download all artifacts'
  #           inputs:
  #             downloadPath: '$(Pipeline.Workspace)/artifacts'
  #
  #         - task: NuGetCommand@2
  #           displayName: 'Push to MyGet'
  #           inputs:
  #             command: 'push'
  #             packagesToPush: '$(Pipeline.Workspace)/artifacts/**/*.nupkg'
  #             nuGetFeedType: 'external'
  #             publishFeedCredentials: 'MyGet-Umbraco-Ai'

  # Stage 5: Deploy to NuGet (release tags only)
  # - stage: DeployNuGet
  #   displayName: 'Deploy to NuGet'
  #   dependsOn: Test
  #   condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/release-'))
  #   jobs:
  #     - job: Deploy
  #       displayName: 'Push packages to NuGet'
  #       pool:
  #         vmImage: $(vmImage)
  #       steps:
  #         - task: DownloadPipelineArtifact@2
  #           displayName: 'Download all artifacts'
  #           inputs:
  #             downloadPath: '$(Pipeline.Workspace)/artifacts'
  #
  #         - task: NuGetCommand@2
  #           displayName: 'Push to NuGet'
  #           inputs:
  #             command: 'push'
  #             packagesToPush: '$(Pipeline.Workspace)/artifacts/**/*.nupkg'
  #             nuGetFeedType: 'external'
  #             publishFeedCredentials: 'NuGet-Umbraco-Ai'
