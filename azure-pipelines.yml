# Azure DevOps CI Pipeline for Umbraco.Ai
# Converted from GitHub Actions (.github/workflows/ci.yml)

# ============================================================
# Product Definitions - UPDATE HERE WHEN ADDING NEW PACKAGES
# ============================================================
# Level 0: Core package (no internal dependencies)
# Level 1: All packages that depend on Core
parameters:
  - name: level1Products
    type: object
    default:
      # Providers
      - name: Umbraco.Ai.OpenAi
        changeVar: OpenaiChanged
      - name: Umbraco.Ai.Anthropic
        changeVar: AnthropicChanged
      - name: Umbraco.Ai.Amazon
        changeVar: AmazonChanged
      - name: Umbraco.Ai.Google
        changeVar: GoogleChanged
      - name: Umbraco.Ai.MicrosoftFoundry
        changeVar: MicrosoftfoundryChanged
      # Add-ons
      - name: Umbraco.Ai.Prompt
        changeVar: PromptChanged
      - name: Umbraco.Ai.Agent
        changeVar: AgentChanged

trigger:
  branches:
    include:
      - main
      - dev
      - release/*
      - hotfix/*
  tags:
    include:
      - release-*

pr:
  branches:
    include:
      - main
      - dev

variables:
  NODE_VERSION: '20.x'
  DOTNET_NOLOGO: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

stages:
  # ============================================================
  # Build & Test everything
  # ============================================================
  - stage: Build
    displayName: Build & Test
    jobs:
      - job: BuildAndTest
        displayName: Build & Test
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: UseDotNet@2
            displayName: Setup .NET
            inputs:
              useGlobalJson: true

          - task: NodeTool@0
            displayName: Setup Node.js
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              npm ci
              npm run build
            displayName: Build frontend

          - script: dotnet restore Umbraco.Ai.sln
            displayName: Restore

          - script: dotnet build Umbraco.Ai.sln --configuration Release --no-restore
            displayName: Build

          - script: dotnet test Umbraco.Ai.sln --configuration Release --no-build --verbosity normal --logger trx --results-directory $(Agent.TempDirectory)/TestResults
            displayName: Test

          - task: PublishTestResults@2
            displayName: Publish test results
            condition: always()
            inputs:
              testResultsFormat: VSTest
              testResultsFiles: '$(Agent.TempDirectory)/TestResults/**/*.trx'
              mergeTestResults: true

          - task: PublishPipelineArtifact@1
            displayName: Upload build outputs
            inputs:
              targetPath: $(Build.SourcesDirectory)
              artifact: build-outputs
              publishLocation: pipeline

  # ============================================================
  # Pack Stage - Only runs on push to main/dev or release tags
  # Uses dynamic change detection to only pack products that changed
  # ============================================================
  - stage: Pack
    displayName: Pack NuGet Packages
    dependsOn: Build
    # Only pack on push (not PR) to main/dev branches or release tags
    condition: |
      and(
        succeeded(),
        ne(variables['Build.Reason'], 'PullRequest'),
        or(
          startsWith(variables['Build.SourceBranch'], 'refs/tags/release-'),
          eq(variables['Build.SourceBranch'], 'refs/heads/main'),
          eq(variables['Build.SourceBranch'], 'refs/heads/dev')
        )
      )
    jobs:
      # ============================================================
      # Detect which products changed
      # ============================================================
      - job: DetectChanges
        displayName: Detect Changed Products
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: PowerShell@2
            displayName: Run change detection
            name: detect
            inputs:
              filePath: .azure-pipelines/scripts/detect-changes.ps1
              pwsh: true

      # ============================================================
      # Pack Core (Level 0 - no internal dependencies)
      # Conditional based on change detection
      # ============================================================
      - job: PackCore
        displayName: Pack Umbraco.Ai
        dependsOn: DetectChanges
        condition: eq(dependencies.DetectChanges.outputs['detect.CoreChanged'], 'true')
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: UseDotNet@2
            displayName: Setup .NET
            inputs:
              useGlobalJson: true

          - task: DownloadPipelineArtifact@2
            displayName: Download build outputs
            inputs:
              artifact: build-outputs
              path: $(Build.SourcesDirectory)

          - template: .azure-pipelines/templates/pack-product.yml
            parameters:
              product: Umbraco.Ai

          - task: PublishPipelineArtifact@1
            displayName: Upload Umbraco.Ai NuGet packages
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/nupkg
              artifact: Umbraco.Ai-packages
              publishLocation: pipeline

          # Upload npm packages if they were created
          - task: Bash@3
            displayName: Check for npm packages
            name: checkNpm
            inputs:
              targetType: inline
              script: |
                if [ -d "artifacts/npm" ] && [ "$(ls -A artifacts/npm 2>/dev/null)" ]; then
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]true"
                  echo "npm packages found:"
                  ls -la artifacts/npm/
                else
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]false"
                  echo "No npm packages to upload"
                fi

          - task: PublishPipelineArtifact@1
            displayName: Upload Umbraco.Ai npm packages
            condition: eq(variables['checkNpm.hasNpmPackages'], 'true')
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/npm
              artifact: Umbraco.Ai-npm-packages
              publishLocation: pipeline

      # ============================================================
      # Pack Level 1 (Providers + Add-ons - depend on Core)
      # Matrix generated from parameters.level1Products
      # ============================================================
      - job: PackLevel1
        displayName: Pack Level 1
        dependsOn:
          - DetectChanges
          - PackCore
        condition: |
          and(
            not(failed()),
            not(canceled()),
            eq(dependencies.DetectChanges.outputs['detect.Level1Changed'], 'true')
          )
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            # Generated from parameters.level1Products
            ${{ each product in parameters.level1Products }}:
              ${{ replace(replace(product.name, 'Umbraco.Ai.', ''), '.', '_') }}:
                product: ${{ product.name }}
                changeVar: ${{ product.changeVar }}
          maxParallel: 10
        variables:
          # Pass all per-product change flags as job variables
          CoreChanged: $[ dependencies.DetectChanges.outputs['detect.CoreChanged'] ]
          ${{ each product in parameters.level1Products }}:
            ${{ product.changeVar }}: $[ dependencies.DetectChanges.outputs['detect.${{ product.changeVar }}'] ]
        steps:
          - checkout: self
            fetchDepth: 0

          # Determine if this specific product should be packed
          # The changeVar from matrix tells us which variable to check
          - task: PowerShell@2
            displayName: Check if $(product) changed
            name: check
            inputs:
              targetType: inline
              pwsh: true
              script: |
                $product = "$(product)"
                $changeVarName = "$(changeVar)"

                # Azure DevOps variables are available as environment variables
                # Variable names are converted: dots become underscores, uppercase
                $envVarName = $changeVarName.ToUpper()
                $changed = [Environment]::GetEnvironmentVariable($envVarName)

                # Also try the original case
                if (-not $changed) {
                  $changed = [Environment]::GetEnvironmentVariable($changeVarName)
                }

                Write-Host "Product: $product"
                Write-Host "Change variable: $changeVarName (env: $envVarName)"
                Write-Host "Changed value: '$changed'"

                if ($changed -eq "true") {
                  Write-Host "##vso[task.setvariable variable=shouldPack;isOutput=true]true"
                  Write-Host "$product changed - will pack"
                } else {
                  Write-Host "##vso[task.setvariable variable=shouldPack;isOutput=true]false"
                  Write-Host "$product not changed - skipping (value was: $changed)"
                }

          - task: UseDotNet@2
            displayName: Setup .NET
            condition: eq(variables['check.shouldPack'], 'true')
            inputs:
              useGlobalJson: true

          - task: DownloadPipelineArtifact@2
            displayName: Download build outputs
            condition: eq(variables['check.shouldPack'], 'true')
            inputs:
              artifact: build-outputs
              path: $(Build.SourcesDirectory)

          # Download Core packages as local feed (if Core was packed)
          - task: DownloadPipelineArtifact@2
            displayName: Download Core packages (local feed)
            condition: |
              and(
                eq(variables['check.shouldPack'], 'true'),
                eq(variables['CoreChanged'], 'true')
              )
            inputs:
              artifact: Umbraco.Ai-packages
              path: $(Build.SourcesDirectory)/artifacts/nupkg

          - template: .azure-pipelines/templates/pack-product.yml
            parameters:
              product: $(product)
              condition: eq(variables['check.shouldPack'], 'true')

          - task: PublishPipelineArtifact@1
            displayName: Upload $(product) NuGet packages
            condition: eq(variables['check.shouldPack'], 'true')
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/nupkg
              artifact: $(product)-packages
              publishLocation: pipeline

          # Upload npm packages if they were created
          - task: Bash@3
            displayName: Check for npm packages
            condition: eq(variables['check.shouldPack'], 'true')
            name: checkNpm
            inputs:
              targetType: inline
              script: |
                if [ -d "artifacts/npm" ] && [ "$(ls -A artifacts/npm 2>/dev/null)" ]; then
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]true"
                  echo "npm packages found:"
                  ls -la artifacts/npm/
                else
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]false"
                  echo "No npm packages to upload"
                fi

          - task: PublishPipelineArtifact@1
            displayName: Upload $(product) npm packages
            condition: |
              and(
                eq(variables['check.shouldPack'], 'true'),
                eq(variables['checkNpm.hasNpmPackages'], 'true')
              )
            inputs:
              targetPath: $(Build.SourcesDirectory)/artifacts/npm
              artifact: $(product)-npm-packages
              publishLocation: pipeline

      # ============================================================
      # Collect all packages into single artifact
      # Downloads artifacts from all pack jobs
      # ============================================================
      - job: CollectPackages
        displayName: Collect All Packages
        dependsOn:
          - DetectChanges
          - PackCore
          - PackLevel1
        condition: |
          and(
            not(failed()),
            not(canceled()),
            eq(dependencies.DetectChanges.outputs['detect.AnyChanged'], 'true')
          )
        pool:
          vmImage: 'ubuntu-latest'
        variables:
          AllChangedProducts: $[ dependencies.DetectChanges.outputs['detect.AllChangedProducts'] ]
        steps:
          - task: Bash@3
            displayName: Download all NuGet package artifacts
            name: collectNuget
            inputs:
              targetType: inline
              script: |
                # Don't use set -e - we want to continue even if some artifacts don't exist
                mkdir -p all-nuget-packages

                if [ -z "$(AllChangedProducts)" ]; then
                  echo "No changed products to collect"
                  echo "##vso[task.setvariable variable=hasNugetPackages;isOutput=true]false"
                  exit 0
                fi

                # Parse comma-separated product list
                IFS=',' read -ra PRODUCTS <<< "$(AllChangedProducts)"

                for product in "${PRODUCTS[@]}"; do
                  echo "Downloading ${product}-packages (NuGet)..."

                  # Use Azure DevOps REST API to download artifact
                  artifact_url="$(System.CollectionUri)$(System.TeamProject)/_apis/build/builds/$(Build.BuildId)/artifacts?artifactName=${product}-packages&api-version=7.0&\$format=zip"

                  # Download with error handling - artifact may not exist if product was skipped
                  if curl -s -L -f \
                    -H "Authorization: Bearer $(System.AccessToken)" \
                    "$artifact_url" \
                    -o "${product}-packages.zip" 2>/dev/null; then

                    if [ -f "${product}-packages.zip" ] && [ -s "${product}-packages.zip" ]; then
                      unzip -o "${product}-packages.zip" -d all-nuget-packages/ || echo "Warning: Failed to unzip ${product}-packages.zip"
                      rm -f "${product}-packages.zip"
                      echo "  Downloaded ${product}-packages"
                    else
                      echo "  Artifact ${product}-packages is empty, skipping"
                      rm -f "${product}-packages.zip" 2>/dev/null || true
                    fi
                  else
                    echo "  Artifact ${product}-packages not found (product may have been skipped)"
                  fi
                done

                # Flatten directory structure (artifacts extract to subdirs)
                find all-nuget-packages -name "*.nupkg" -exec mv {} all-nuget-packages/ \; 2>/dev/null || true
                find all-nuget-packages -name "*.snupkg" -exec mv {} all-nuget-packages/ \; 2>/dev/null || true
                # Delete empty subdirectories but keep the top-level directory
                find all-nuget-packages -mindepth 1 -type d -empty -delete 2>/dev/null || true

                # Check if any NuGet packages were collected
                if [ -d "all-nuget-packages" ] && [ "$(ls -A all-nuget-packages 2>/dev/null)" ]; then
                  echo "##vso[task.setvariable variable=hasNugetPackages;isOutput=true]true"
                  echo ""
                  echo "Collected NuGet packages:"
                  ls -la all-nuget-packages/
                else
                  echo "##vso[task.setvariable variable=hasNugetPackages;isOutput=true]false"
                  echo "No NuGet packages collected"
                fi

          - task: Bash@3
            displayName: Download all npm package artifacts
            name: collectNpm
            inputs:
              targetType: inline
              script: |
                set -e
                mkdir -p all-npm-packages

                if [ -z "$(AllChangedProducts)" ]; then
                  echo "No changed products to collect"
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]false"
                  exit 0
                fi

                # Parse comma-separated product list
                IFS=',' read -ra PRODUCTS <<< "$(AllChangedProducts)"

                for product in "${PRODUCTS[@]}"; do
                  echo "Checking for ${product}-npm-packages..."

                  # Use Azure DevOps REST API to download artifact (npm packages are optional)
                  artifact_url="$(System.CollectionUri)$(System.TeamProject)/_apis/build/builds/$(Build.BuildId)/artifacts?artifactName=${product}-npm-packages&api-version=7.0&\$format=zip"

                  curl -s -L \
                    -H "Authorization: Bearer $(System.AccessToken)" \
                    "$artifact_url" \
                    -o "${product}-npm-packages.zip" 2>/dev/null || true

                  if [ -f "${product}-npm-packages.zip" ] && [ -s "${product}-npm-packages.zip" ]; then
                    echo "  Found npm packages for ${product}"
                    unzip -o "${product}-npm-packages.zip" -d all-npm-packages/ || echo "Warning: Failed to unzip ${product}-npm-packages.zip"
                    rm -f "${product}-npm-packages.zip"
                  else
                    echo "  No npm packages for ${product} (expected for most products)"
                    rm -f "${product}-npm-packages.zip" 2>/dev/null || true
                  fi
                done

                # Flatten directory structure (artifacts extract to subdirs)
                find all-npm-packages -name "*.tgz" -exec mv {} all-npm-packages/ \; 2>/dev/null || true
                # Delete empty subdirectories but keep the top-level directory
                find all-npm-packages -mindepth 1 -type d -empty -delete 2>/dev/null || true

                # Check if any npm packages were collected
                if [ -d "all-npm-packages" ] && [ "$(ls -A all-npm-packages 2>/dev/null)" ]; then
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]true"
                  echo ""
                  echo "Collected npm packages:"
                  ls -la all-npm-packages/
                else
                  echo "##vso[task.setvariable variable=hasNpmPackages;isOutput=true]false"
                  echo "No npm packages collected"
                fi

          - task: PublishPipelineArtifact@1
            displayName: Upload combined NuGet artifact
            condition: eq(variables['collectNuget.hasNugetPackages'], 'true')
            inputs:
              targetPath: $(Build.SourcesDirectory)/all-nuget-packages
              artifact: all-nuget-packages
              publishLocation: pipeline

          - task: PublishPipelineArtifact@1
            displayName: Upload combined npm artifact
            condition: eq(variables['collectNpm.hasNpmPackages'], 'true')
            inputs:
              targetPath: $(Build.SourcesDirectory)/all-npm-packages
              artifact: all-npm-packages
              publishLocation: pipeline
