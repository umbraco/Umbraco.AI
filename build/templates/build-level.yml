# Dynamic template for building all products at a specific dependency level
# Uses matrix strategy with runtime variables from detect-changes.ps1

parameters:
  - name: level
    type: number
  - name: levelProductsVariable
    type: string  # e.g., 'level0Products'
  - name: configuration
    type: string
    default: 'Release'

jobs:
  - job: Build_Level_${{ parameters.level }}
    displayName: 'Build Level ${{ parameters.level }} Products'
    pool:
      vmImage: 'ubuntu-latest'

    # Dynamic matrix based on detected products at this level
    strategy:
      matrix: $[ stageDependencies.DetectChanges.DetectChanges.outputs['detectChanges.${{ parameters.levelProductsVariable }}'] ]

    variables:
      productName: $(name)
      productPath: $(path)
      hasFrontend: $(hasFrontend)

    steps:
      - checkout: self
        fetchDepth: 0

      - task: UseDotNet@2
        displayName: 'Install .NET SDK'
        inputs:
          version: '10.x'

      # Build frontend if applicable
      - task: NodeTool@0
        displayName: 'Install Node.js'
        condition: eq(variables.hasFrontend, 'true')
        inputs:
          versionSpec: '20.x'

      - script: |
          cd $(productPath)/src/$(productName).Web.StaticAssets/Client
          npm ci
          npm run build
        displayName: 'Build frontend assets'
        condition: eq(variables.hasFrontend, 'true')

      # Run NBGV
      - task: DotNetCoreCLI@2
        displayName: 'Install NBGV tool'
        inputs:
          command: 'custom'
          custom: 'tool'
          arguments: 'install --global nbgv'

      - script: |
          cd $(productPath)
          nbgv cloud
        displayName: 'Set version from NBGV'

      # Build
      - task: DotNetCoreCLI@2
        displayName: 'Restore NuGet packages'
        inputs:
          command: 'restore'
          projects: '$(productPath)/$(productName).sln'

      - task: DotNetCoreCLI@2
        displayName: 'Build solution'
        inputs:
          command: 'build'
          projects: '$(productPath)/$(productName).sln'
          arguments: '--configuration ${{ parameters.configuration }} --no-restore -p:UseProjectReferences=false'

      - task: DotNetCoreCLI@2
        displayName: 'Pack NuGet packages'
        inputs:
          command: 'pack'
          packagesToPack: '$(productPath)/$(productName).sln'
          configuration: '${{ parameters.configuration }}'
          packDirectory: '$(Build.ArtifactStagingDirectory)/nupkg'
          nobuild: true
          buildProperties: 'UseProjectReferences=false'

      # Publish artifacts
      - task: PublishPipelineArtifact@1
        displayName: 'Publish NuGet packages'
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/nupkg'
          artifactName: '$(productName)-packages'
