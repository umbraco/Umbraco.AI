# Reusable template for building a single Umbraco.Ai product
# Parameters:
#   productName: Display name (e.g., "Umbraco.Ai")
#   productPath: Folder path (e.g., "Umbraco.Ai")
#   hasFrontend: Whether product has frontend assets to build

parameters:
  - name: productName
    type: string
  - name: productPath
    type: string
  - name: hasFrontend
    type: boolean
    default: false
  - name: configuration
    type: string
    default: 'Release'

jobs:
  - job: Build_${{ replace(parameters.productName, '.', '_') }}
    displayName: 'Build ${{ parameters.productName }}'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
      - checkout: self
        fetchDepth: 0  # Full history required for NBGV

      - task: UseDotNet@2
        displayName: 'Install .NET SDK'
        inputs:
          version: '10.x'

      # Build frontend if applicable
      - ${{ if eq(parameters.hasFrontend, true) }}:
        - task: NodeTool@0
          displayName: 'Install Node.js'
          inputs:
            versionSpec: '20.x'

        - script: |
            cd ${{ parameters.productPath }}/src/${{ parameters.productName }}.Web.StaticAssets/Client
            npm ci
            npm run build
          displayName: 'Build frontend assets'

      # Run NBGV to get version
      - task: DotNetCoreCLI@2
        displayName: 'Install NBGV tool'
        inputs:
          command: 'custom'
          custom: 'tool'
          arguments: 'install --global nbgv'

      - script: |
          cd ${{ parameters.productPath }}
          nbgv cloud
        displayName: 'Set version from NBGV'

      # Restore packages
      - task: DotNetCoreCLI@2
        displayName: 'Restore NuGet packages'
        inputs:
          command: 'restore'
          projects: '${{ parameters.productPath }}/${{ parameters.productName }}.sln'

      # Build + Pack with package references (not project references)
      - task: DotNetCoreCLI@2
        displayName: 'Build solution'
        inputs:
          command: 'build'
          projects: '${{ parameters.productPath }}/${{ parameters.productName }}.sln'
          arguments: '--configuration ${{ parameters.configuration }} --no-restore -p:UseProjectReferences=false'

      - task: DotNetCoreCLI@2
        displayName: 'Pack NuGet packages'
        inputs:
          command: 'pack'
          packagesToPack: '${{ parameters.productPath }}/${{ parameters.productName }}.sln'
          configuration: '${{ parameters.configuration }}'
          packDirectory: '$(Build.ArtifactStagingDirectory)/nupkg'
          nobuild: true
          buildProperties: 'UseProjectReferences=false'

      # Publish artifacts
      - task: PublishPipelineArtifact@1
        displayName: 'Publish NuGet packages'
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/nupkg'
          artifactName: '${{ parameters.productName }}-packages'
