# Reusable build steps for a single Umbraco.Ai product
# Uses runtime variables set by the matrix strategy:
#   - productName: Display name (e.g., "Umbraco.Ai")
#   - productPath: Folder path (e.g., "Umbraco.Ai")
#   - hasFrontend: Whether product has frontend assets to build

parameters:
  - name: configuration
    type: string
    default: 'Release'

steps:
  - checkout: self
    fetchDepth: 0  # Full history required for NBGV

  - task: UseDotNet@2
    displayName: 'Install .NET SDK'
    inputs:
      version: '10.x'

  # Build frontend if applicable
  - task: NodeTool@0
    displayName: 'Install Node.js'
    condition: eq(variables.hasFrontend, 'true')
    inputs:
      versionSpec: '20.x'

  - script: |
      cd $(productPath)/src/$(productName).Web.StaticAssets/Client
      npm ci
      npm run build
    displayName: 'Build frontend assets'
    condition: eq(variables.hasFrontend, 'true')

  # Run NBGV to get version
  - task: DotNetCoreCLI@2
    displayName: 'Install NBGV tool'
    inputs:
      command: 'custom'
      custom: 'tool'
      arguments: 'install --global nbgv'

  - script: |
      cd $(productPath)
      nbgv cloud
    displayName: 'Set version from NBGV'

  # Restore packages
  - task: DotNetCoreCLI@2
    displayName: 'Restore NuGet packages'
    inputs:
      command: 'restore'
      projects: '$(productPath)/$(productName).sln'

  # Build + Pack with package references (not project references)
  - task: DotNetCoreCLI@2
    displayName: 'Build solution'
    inputs:
      command: 'build'
      projects: '$(productPath)/$(productName).sln'
      arguments: '--configuration ${{ parameters.configuration }} --no-restore -p:UseProjectReferences=false'

  - task: DotNetCoreCLI@2
    displayName: 'Pack NuGet packages'
    inputs:
      command: 'pack'
      packagesToPack: '$(productPath)/$(productName).sln'
      configuration: '${{ parameters.configuration }}'
      packDirectory: '$(Build.ArtifactStagingDirectory)/nupkg'
      nobuild: true
      buildProperties: 'UseProjectReferences=false'

  # Publish artifacts
  - task: PublishPipelineArtifact@1
    displayName: 'Publish NuGet packages'
    inputs:
      targetPath: '$(Build.ArtifactStagingDirectory)/nupkg'
      artifactName: '$(productName)-packages'
