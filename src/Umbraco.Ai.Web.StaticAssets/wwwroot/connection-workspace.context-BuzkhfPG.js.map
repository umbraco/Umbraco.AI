{"version":3,"file":"connection-workspace.context-BuzkhfPG.js","sources":["../Client/src/core/command/command.store.ts","../Client/src/connection/workspace/connection-workspace.context.ts"],"sourcesContent":["import type { UaiCommand } from \"./command.base.js\";\r\n\r\nexport class UaiCommandStore {\r\n    #muted = false;\r\n    #commands: UaiCommand[] = [];\r\n\r\n    add(command: UaiCommand) {\r\n        if (this.#muted) return;\r\n        // Replace command with same correlationId or append\r\n        this.#commands = [\r\n            ...this.#commands.filter(x => !command.correlationId || x.correlationId !== command.correlationId),\r\n            command,\r\n        ];\r\n    }\r\n\r\n    getAll(): UaiCommand[] {\r\n        return this.#muted ? [] : [...this.#commands];\r\n    }\r\n\r\n    mute() { this.#muted = true; }\r\n    unmute() { this.#muted = false; }\r\n    clear() { this.#commands = []; }\r\n    reset() { this.clear(); this.unmute(); }\r\n}\r\n","import type { UmbRoutableWorkspaceContext } from \"@umbraco-cms/backoffice/workspace\";\r\nimport { UmbWorkspaceRouteManager, UmbSubmittableWorkspaceContextBase } from \"@umbraco-cms/backoffice/workspace\";\r\nimport { UmbContextToken } from \"@umbraco-cms/backoffice/context-api\";\r\nimport type { UmbControllerHost } from \"@umbraco-cms/backoffice/controller-api\";\r\nimport { UmbBasicState, UmbObjectState } from \"@umbraco-cms/backoffice/observable-api\";\r\nimport { UmbEntityContext } from \"@umbraco-cms/backoffice/entity\";\r\nimport { UmbValidationContext } from \"@umbraco-cms/backoffice/validation\";\r\nimport { UaiConnectionDetailRepository } from \"../repository/detail/connection-detail.repository.js\";\r\nimport { UaiConnectionConstants } from \"../constants.js\";\r\nimport type { UaiConnectionDetailModel } from \"../types.js\";\r\nimport type { UaiCommand } from \"../../core/command/command.base.js\";\r\nimport { UaiCommandStore } from \"../../core/command/command.store.js\";\r\n\r\nexport const UAI_CONNECTION_WORKSPACE_CONTEXT = new UmbContextToken<UaiConnectionWorkspaceContext>(\r\n    \"UmbWorkspaceContext\",\r\n    undefined,\r\n    (context): context is UaiConnectionWorkspaceContext =>\r\n        context.getEntityType() === UaiConnectionConstants.EntityType.Entity\r\n);\r\n\r\n/**\r\n * Workspace context for editing Connection entities.\r\n * Handles CRUD operations, state management, and command tracking.\r\n */\r\nexport class UaiConnectionWorkspaceContext\r\n    extends UmbSubmittableWorkspaceContextBase<UaiConnectionDetailModel>\r\n    implements UmbRoutableWorkspaceContext\r\n{\r\n    readonly routes = new UmbWorkspaceRouteManager(this);\r\n\r\n    #unique = new UmbBasicState<string | undefined>(undefined);\r\n    readonly unique = this.#unique.asObservable();\r\n\r\n    #model = new UmbObjectState<UaiConnectionDetailModel | undefined>(undefined);\r\n    readonly model = this.#model.asObservable();\r\n\r\n    #repository: UaiConnectionDetailRepository;\r\n    #commandStore = new UaiCommandStore();\r\n    #entityContext = new UmbEntityContext(this);\r\n\r\n    constructor(host: UmbControllerHost) {\r\n        super(host, UaiConnectionConstants.Workspace.Entity);\r\n\r\n        this.#repository = new UaiConnectionDetailRepository(this);\r\n        this.addValidationContext(new UmbValidationContext(this));\r\n\r\n        this.#entityContext.setEntityType(UaiConnectionConstants.EntityType.Entity);\r\n        this.observe(this.unique, (unique) => this.#entityContext.setUnique(unique ?? null));\r\n    }\r\n\r\n    protected resetState(): void {\r\n        super.resetState();\r\n        this.#unique.setValue(undefined);\r\n        this.#model.setValue(undefined);\r\n        this.#commandStore.reset();\r\n    }\r\n\r\n    /**\r\n     * Creates a scaffold for a new connection.\r\n     */\r\n    async scaffold(providerId?: string) {\r\n        this.resetState();\r\n        const { data } = await this.#repository.createScaffold({ providerId });\r\n        if (data) {\r\n            this.#model.setValue(data);\r\n            this.setIsNew(true);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Loads an existing connection by ID.\r\n     */\r\n    async load(id: string) {\r\n        this.resetState();\r\n        const { data, asObservable } = await this.#repository.requestByUnique(id);\r\n\r\n        if (asObservable) {\r\n            this.observe(\r\n                asObservable(),\r\n                (model) => {\r\n                    if (model) {\r\n                        this.#unique.setValue(model.unique);\r\n                        const newModel = structuredClone(model);\r\n                        // Replay any pending commands\r\n                        this.#commandStore.getAll().forEach((command) => command.execute(newModel));\r\n                        this.#model.setValue(newModel);\r\n                        this.setIsNew(false);\r\n                    }\r\n                },\r\n                \"_observeModel\"\r\n            );\r\n        }\r\n\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * Handles a command to update the model.\r\n     * Commands are tracked for replay after model refresh.\r\n     */\r\n    handleCommand(command: UaiCommand) {\r\n        const currentValue = this.#model.getValue();\r\n        if (currentValue) {\r\n            const newValue = structuredClone(currentValue);\r\n            command.execute(newValue);\r\n            this.#model.setValue(newValue);\r\n            this.#commandStore.add(command);\r\n        }\r\n    }\r\n\r\n    getData(): UaiConnectionDetailModel | undefined {\r\n        return this.#model.getValue();\r\n    }\r\n\r\n    getUnique(): string | undefined {\r\n        return this.#unique.getValue();\r\n    }\r\n\r\n    getEntityType(): string {\r\n        return UaiConnectionConstants.EntityType.Entity;\r\n    }\r\n\r\n    /**\r\n     * Saves the connection (create or update).\r\n     */\r\n    async submit() {\r\n        const model = this.#model.getValue();\r\n        if (!model) return;\r\n\r\n        // Mute command store during submit\r\n        this.#commandStore.mute();\r\n\r\n        try {\r\n            if (this.getIsNew()) {\r\n                const { data, error } = await this.#repository.create(model);\r\n\r\n                if (error) {\r\n                    throw error;\r\n                }\r\n\r\n                if (data) {\r\n                    this.#unique.setValue(data.unique);\r\n                    this.#model.setValue(data);\r\n                }\r\n            } else {\r\n                const { error } = await this.#repository.save(model);\r\n\r\n                if (error) {\r\n                    throw error;\r\n                }\r\n            }\r\n\r\n            this.#commandStore.reset();\r\n            this.setIsNew(false);\r\n        } finally {\r\n            this.#commandStore.unmute();\r\n        }\r\n    }\r\n}\r\n\r\nexport { UaiConnectionWorkspaceContext as api };\r\n"],"names":["UaiCommandStore","#muted","#commands","command","x","UAI_CONNECTION_WORKSPACE_CONTEXT","UmbContextToken","context","UaiConnectionConstants","UaiConnectionWorkspaceContext","UmbSubmittableWorkspaceContextBase","host","UmbWorkspaceRouteManager","#unique","UmbBasicState","#model","UmbObjectState","#commandStore","#entityContext","UmbEntityContext","#repository","UaiConnectionDetailRepository","UmbValidationContext","unique","providerId","data","id","asObservable","model","newModel","currentValue","newValue","error"],"mappings":"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"}